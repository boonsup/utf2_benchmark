name: ğŸ§¬ UTFv2 Multi-Stage Pipeline (Test â†’ Sandbox â†’ Production)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  # ---------------------------------------------------
  # 1ï¸âƒ£ TEST STAGE
  # ---------------------------------------------------
  test:
    name: âœ… Test & Validate UTFv2 Core
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§° Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: utf2
          environment-file: environment.yml
          auto-activate-base: false

      - name: ğŸ§ª Run Unit Tests
        shell: bash -l {0}
        run: |
          conda install -y pytest matplotlib pandas numpy
          pytest -v --maxfail=1 --disable-warnings

      - name: ğŸ§© Validate Notebook Execution
        shell: bash -l {0}
        run: |
          conda install -y jupyter nbconvert
          jupyter nbconvert --to notebook --execute notebooks/utf_main.ipynb --output utf_validated.ipynb
          echo "âœ… Notebook executed successfully"

  # ---------------------------------------------------
  # 2ï¸âƒ£ SANDBOX RELEASE (DRY-RUN)
  # ---------------------------------------------------
  sandbox:
    name: ğŸ§ª Sandbox DOI Sync (Dry-Run)
    needs: [test]
    if: github.event.release.prerelease == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: utf2
          environment-file: environment.yml
          auto-activate-base: false

      - name: ğŸ”„ Run Sandbox Upload (Dry-Run)
        shell: bash -l {0}
        run: |
          python zenodo_upload.py --sandbox
          python scripts/update_doi_references.py --doi "10.5072/zenodo.344960" \
              --readme README.md --cff CITATION.cff --zenodo zenodo.json --bib tex/references.bib --with-keywords true

      - name: ğŸ§¾ Commit Sandbox DOI Updates
        run: |
          git config user.name "utf-bot"
          git config user.email "utf-bot@users.noreply.github.com"
          git add README.md CITATION.cff zenodo.json tex/references.bib || true
          git commit -m "ğŸ§ª Sandbox DOI dry-run auto-sync" || true
          git push origin zenodo-dryrun || true

      - name: ğŸ’¬ Post Sandbox Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.release.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸ§ª Sandbox DOI test complete â†’ `10.5072/zenodo.344960`"
            })

  # ---------------------------------------------------
  # 3ï¸âƒ£ PRODUCTION RELEASE
  # ---------------------------------------------------
  production:
    name: ğŸš€ Production DOI Sync & Publish
    needs: [test]
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: utf2
          environment-file: environment.yml
          auto-activate-base: false

      - name: ğŸ”§ Install Dependencies
        shell: bash -l {0}
        run: |
          conda install -y python-dotenv requests pyyaml pandas matplotlib
          pip install tomlkit

      - name: ğŸ“¦ Upload & Sync with Zenodo (Production)
        shell: bash -l {0}
        run: |
          python zenodo_upload.py
          python scripts/update_doi_references.py \
            --doi $(grep -oE '10\.5281/zenodo\.[0-9]+' zenodo.json | head -n1) \
            --readme README.md --cff CITATION.cff --zenodo zenodo.json --bib tex/references.bib --with-keywords true
          python scripts/auto_embed_figures.py
          python scripts/git_commit_release.py --ci --tag ${{ github.ref_name }}

      - name: ğŸ§¾ Verify Sy
      - name: ğŸ§¾ Update README Release Dashboard
        shell: bash -l {0}
        run: |
          python scripts/build_release_dashboard.py
          git add README.md
          git commit -m "ğŸ“¦ Update release dashboard table"
          git push

- name: ğŸ“¦ Pack arXiv and Zenodo bundles
  run: |
    python scripts/pack_arxiv_preprint.py --version v1.0 --doi $DOI
    python scripts/pack_zenodo_bundle.py
